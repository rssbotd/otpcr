#!/usr/bin/env python3
# This file is placed in the Public Domain.
# pylint: disable=C0413,W0212,W0613,E0401


"main"


import getpass
import os
import sys


sys.path.insert(0, os.getcwd())


from otpcr.cfg    import Config
from otpcr.cmds   import Commands
from otpcr.errors import errors
from otpcr.disk   import Persist, skel
from otpcr.main   import cmnd, enable, scan
from otpcr.parse  import parse
from otpcr.utils  import modnames, privileges


from otpcr import modules, user


Cfg         = Config()
Cfg.mod     = "cmd,skl,req,srv"
Cfg.name    = "otpcr"
Cfg.user    = getpass.getuser()
Cfg.wdr     = os.path.expanduser(f"~/.{Cfg.name}")
Cfg.pidfile = os.path.join(Cfg.wdr, f"{Cfg.name}.pid")


Persist.workdir = Cfg.wdr



import getpass


def srv(event):
    "create service file (pipx)."
    if event.args:
        username = event.args[0]
    else:
        username  = getpass.getuser()
    txt = f"""[Unit]
Description={Cfg.name.upper()}
Requires=network-online.target
After=network-online.target

[Service]
Type=simple
User={username}
Group={username}
ExecStartPre=/home/{username}/.local/bin/{Cfg.name} skl
ExecStart=/home/{username}/.local/bin/{Cfg.name}d
ExitType=cgroup
KillSignal=SIGKILL
KillMode=control-group
RemainAfterExit=yes
Restart=no

[Install]
WantedBy=default.target"""
    event.reply(txt)


def main():
    "main"
    Commands.add(srv)
    parse(Cfg, " ".join(sys.argv[1:]))
    enable(print)
    Cfg.dis = Cfg.sets.dis
    if "a" in Cfg.opts:
        Cfg.mod = ",".join(modnames(modules, user))
    scan(Cfg.mod, modules, user)
    cmnd(Cfg.otxt, print)


if __name__ == "__main__":
    main()
    errors()
